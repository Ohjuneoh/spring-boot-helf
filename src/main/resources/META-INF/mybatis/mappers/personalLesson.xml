<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="kr.co.helf.mapper.PersonalLessonMapper">

	<select id="getCareerByTrainerNo" parameterType="int" resultType="Career">
		select
			career_no,
			career_name,
			career_start_date,
			career_end_date,
			trainer_no
		from helf_trainer_career
		where
			trainer_no = #{value}
		order by
			career_start_date;
	</select>
	<!-- User 테이블에서 트레이너 번호로 전체 트레이너 찾기  -->
	<select id="getUserByTrainerNo" parameterType="int" resultType="User">
				select
			user_id					as id,
			user_email				as email,
			user_name				as name,
			user_tel				as tel,
			user_encrypted_password as encryptedPassword,
			user_gender				as gender,
			user_status				as status,
			user_mobile_carrier		as mobileCarrier,
			user_create_date		as createDate,
			user_update_date		as updateDate,
			user_point				as point,
			rank_no					as "rank.no",
			user_type				as type
			
		from
			helf_users
		where 
			trainer_no = #{value}
			
	</select>
	<resultMap type="kr.co.helf.vo.Trainer" id="getAllTrainersWithCareer" >
    	<id column="trainer_no" property="trainerNo"/>
    	<result column="trainer_file" property="trainerFile"/>
    	<association property="user" javaType="kr.co.helf.vo.User">
    		<id column="user_id" property="id"/>
    		<result column="name" property="name"/>
    	</association>
    	<collection property="careers" ofType="Career">
        	<id column="career_no" property="careerNo"/>
        	<result column="career_name" property="careerName"/>
        	<result column="career_start_date" property="careerStartDate"/>
        	<result column="career_end_date" property="careerEndDate"/>
    	</collection>
	</resultMap>
	<select id="getAllTrainersWithCareer" resultMap="getAllTrainersWithCareer">
		select
			b.trainer_no,
			a.user_name	as name,
			b.trainer_file,
			c.career_no,
			c.career_name,
			c.career_start_date,
			c.career_end_date
		from
		    helf_users a, helf_trainers b, helf_trainer_career c
		where
			a.user_id = b.user_id
        and c.trainer_no = b.trainer_no
        and c.trainer_no not in (
    								select trainer_no
									from helf_lesson_consultation
									where user_id = #{userId}
									and (lesson_consultation_status = '수강중' or lesson_consultation_status = '대기중'))
		order by
			trainer_no
	</select>

	<!-- 트레이너 상세조회 (유리) -->
	<resultMap type="kr.co.helf.vo.Trainer" id="TrainerAndCareerResultMap" >
    	<id column="trainer_no" property="trainerNo"/>
    	<result column="trainer_file" property="trainerFile"/>
    	<result column="trainer_title" property="title"/>
    	<result column="trainer_resignation_date" property="resignationDate"/>
    	<result column="trainer_hired_date" property="hiredDate"/>
    	<association property="user" javaType="kr.co.helf.vo.User">
    		<id column="user_id" property="id"/>
    		<result column="name" property="name"/>
    	</association>
    	<collection property="careers" ofType="Career">
        	<id column="career_no" property="careerNo"/>
        	<result column="career_name" property="careerName"/>
        	<result column="career_start_date" property="careerStartDate"/>
        	<result column="career_end_date" property="careerEndDate"/>
    	</collection>
	</resultMap>
	<select id="getTrainerAndCareer" parameterType="string" resultMap="TrainerAndCareerResultMap">
		select
			t.trainer_no,
			t.trainer_file,
			t.trainer_title,
			t.trainer_resignation_date,
			t.trainer_hired_date,
			u.user_name	as name,
			tc.career_no,
			tc.career_name,
			tc.career_start_date,
			tc.career_end_date
		from
		    helf_users u, helf_trainers t, helf_trainer_career tc
		where
        	u.user_id = t.user_id
        and	t.trainer_no = tc.trainer_no
        and u.user_id =#{value}
	</select>
	
	<!--입장 form - 오늘 수업 조회 written by 채경 -->
	<select id="getMyTodayLessonsByUserId" resultType="kr.co.helf.vo.LessonApply">
		select C.user_id						as "user.id", 
				C.user_name						as "user.name", 
				C.user_type						as "user.type",
				D.user_id						as "lesson.user.id", 
				D.user_name						as "lesson.user.name", 
				D.user_type						as "lesson.user.type",
				A.lesson_name					as "lesson.name", 
				A.lesson_time					as "lesson.time", 
				A.lesson_date					as "lesson.date",
				B.my_membership_no				as "myMembership.no",
                E.my_membership_remainder_cnt	as "myMembership.remainderCnt",
                E.my_membership_endDate			as "myMembership.endDate",
                F.category_no					as "myMembership.membership.category.no"
		from 
			helf_lesson A, helf_Lesson_Apply B, helf_users C, helf_users D, helf_my_membership E, helf_membership F
		where 
			C.user_id = #{value}
			and A.lesson_no = B.lesson_no
			and B.user_id = C.user_id
			and A.user_id = D.user_id 
			and A.lesson_date = trunc(sysdate)
            and B.my_membership_no = E.my_membership_no
            and E.membership_no = F.membership_no
		order by
			A.lesson_time
	</select>
	
  
	<insert id="insertConsultation" parameterType="Consultation">
		insert into helf_lesson_consultation(lesson_consultation_no, 
											 lesson_consultation_exercise_goal,
											 lesson_consultation_physical_abnormalities,
											 lesson_consultation_request_date,
											 lesson_consultation_request_time,
											 user_id,
											 trainer_no,
											 my_membership_no)
		values(helf_lesson_consultation_seq.nextval, #{goal}, #{abnormalities}, #{requestDate}, #{requestTime}, #{user.id}, #{trainer.trainerNo}, #{myMembership.no})
	</insert>
	<resultMap id="UserMyMembershipsMap" type="kr.co.helf.dto.UserMyMemberships">
	    <!-- Membership 객체 매핑 -->
	    <association property="membership" javaType="kr.co.helf.vo.Membership">
	        <result column="membership_no" property="no"/>
	        <result column="membership_name" property="name"/>
	    </association>
	
	    <!-- MyMembership 객체 리스트 매핑 -->
	    <collection property="myMembership" ofType="kr.co.helf.vo.MyMembership">
	        <result column="my_membership_startdate" property="startDate"/>
	        <result column="my_membership_no" property="no"/>
	        <result column="my_membership_enddate" property="endDate"/>
	        <result column="my_membership_remainder_cnt" property="remainderCnt"/>
	        <result column="my_membership_state" property="state"/>
	    </collection>
	</resultMap>
	<select id="getUserMyMembershipById" parameterType="string"  resultMap="UserMyMembershipsMap">
		select b.membership_no,
				b.my_membership_no,
		        a.membership_name,
		        b.my_membership_startdate,
		        b.my_membership_enddate,
		        b.my_membership_remainder_cnt,
	       		b.my_membership_state
		from 	helf_membership a, helf_my_membership b
		where 	a.membership_no = b.membership_no
		and 	b.user_id = #{userId}
		and 	a.category_no = 4
        and     b.my_membership_state = '사용가능'
		ORDER BY b.my_membership_no asc
	</select>
	<select id="getTrainerByUserId" parameterType="string" resultType="Trainer">
		select trainer_no 		as trainerNo
		from helf_trainers
		where user_id = #{userId}
	</select>
	<select id="getUserByUserId" parameterType="string" resultType="User">
		select user_id  as id,
        		user_name as name,
        		user_status as status,
        		rank_no     as rankNo
		from helf_users
		where 	user_id=#{userId};
	</select>
	<resultMap id="UserConsultationMap" type="kr.co.helf.dto.UserConsultations">
    <!-- User 객체 매핑 -->
    <association property="user" javaType="kr.co.helf.vo.User">
        <result column="user_id" property="id"/>
        <result column="user_name" property="name"/>
        <association property="rank" javaType="kr.co.helf.vo.Rank">
        <result column="rank_no" property="no"/>
        </association>
    </association>
    
    <!-- Consultation 객체 매핑 -->
    <association property="consultations" javaType="kr.co.helf.vo.Consultation">
        <result column="lesson_consultation_no" property="consultationNo"/>
        <result column="lesson_consultation_status" property="consultationStatus"/>
        <result column="lesson_consultation_application_date" property="applicationDate"/>
        <result column="lesson_consultation_exercise_goal" property="goal"/>
        <result column="lesson_consultation_physical_abnormalities" property="abnormalities"/>
        <result column="lesson_consultation_request_date" property="requestDate"/>
        <result column="lesson_consultation_request_time" property="requestTime"/>
        <association property="lesson" javaType="kr.co.helf.vo.Lesson">
        <result column="lesson_no" property="no"/>
        </association>
         <association property="trainer" javaType="kr.co.helf.vo.Trainer">
        <result column="trainer_no" property="trainerNo"/>
        </association>
        <association property="myMembership" javaType="kr.co.helf.vo.MyMembership">
        <result column="my_membership_no" property="no"/>
        <result column="my_membership_remainder_cnt" property="remainderCnt"/>
        <result column="my_membership_state" property="state"/>
        </association>
    </association>
	</resultMap>
	<select id="getAllConsultationByTrainerNo" parameterType="int" resultMap="UserConsultationMap">
		select a.lesson_consultation_no,
		        a.lesson_consultation_status,
		        a.lesson_no,
		        a.lesson_consultation_application_date,
		        a.lesson_consultation_exercise_goal,
		        a.lesson_consultation_physical_abnormalities,
		        a.lesson_consultation_request_date,
		        a.lesson_consultation_request_time,
		        a.user_id,
		        a.trainer_no,
		        a.my_membership_no,
		        b.user_name,
		        c.my_membership_remainder_cnt,
		        c.my_membership_state
		from helf_lesson_consultation a, helf_users b, helf_my_membership c, helf_membership d
		where a.trainer_no = #{trainerNo}
		and a.user_id = b.user_id
		and a.user_id = c.user_id
        and c.membership_no = d.membership_no
		and c.my_membership_remainder_cnt > 0
		and (c.my_membership_state = '사용가능' or c.my_membership_state = '사용중')
		and (a.lesson_consultation_status = '대기중' or a.lesson_consultation_status = '수강중')
        and d.category_no = 4
		order by a.lesson_consultation_request_date asc
	</select>
	<select id="getMyMembershipByNo" parameterType="int" resultType="myMembership">
		select my_membership_no as no,
        my_membership_startdate as startDate,
        my_membership_enddate   as endDate,
        my_membership_remainder_cnt as remainderCnt,
        my_membership_state     as state
		from    helf_my_membership
		where my_membership_no = #{myMembershipNo}
		and (my_membership_state = '사용가능' or my_membership_state = '사용중')
	</select>
	<update id="updateMyMembership" parameterType="myMembership">
		update helf_my_membership
		set	my_membership_remainder_cnt = #{remainderCnt},
			my_membership_state = #{state}
		where my_membership_no = #{no}
	</update>
	<update id="updatedConsultation" parameterType="Consultation">
		update helf_lesson_consultation
		set lesson_consultation_status = #{status} 
		where lesson_consultation_no = #{consultationNo}
	</update>
	<select id="getConsultationByNo" parameterType="int" resultType="Consultation">
		select lesson_consultation_no	as consultationNo,
			   lesson_consultation_status	as consultationStatus
		from	helf_lesson_consultation
		where lesson_consultation_no = #{consultationNo}
	</select>
	<insert id="insertPersonalLesson" parameterType="PersonalLesson">
		insert into helf_personal_lesson(personal_lesson_no, 
											 personal_lesson_name,
											 personal_lesson_date,
											 personal_lesson_time,
											 personal_lesson_content,
											 my_membership_no,
                                             trainer_no,
                                             user_id)
											 
		values(helf_personal_lesson_seq.nextval, #{name}, #{date}, #{time}, #{content}, #{myMembership.no}, #{trainer.trainerNo}, #{user.id})
	</insert>
	<!-- 상담 만료 업데이트  -->
	<update id="updateExpiredConsultation"  parameterType="Consultation">
		update helf_lesson_consultation
		set lesson_consultation_status = '상담만료' 
		where my_membership_no = #{no}
		and user_id = #{id}
		and lesson_consultation_status = '대기중'
	</update>
	<!-- 유저 ID, 트레이너 번호로 상담내역 조회하기  -->
	<select id="getConsultationByUserId" parameterType="string" resultType="UserConsultations">
		select a.lesson_consultation_no	as consultationNo,
               a.lesson_consultation_application_date as applicationDate,
               a.lesson_consultation_exercise_goal as goal,
               a.lesson_consultation_physical_abnormalities as abnormalities,
               a.lesson_consultation_request_date as requestDate,
               a.lesson_consultation_request_time as requestTime,
               b.user_id                           as "user.id",
               c.trainer_no                       as  "trainer.trainerNo",
			   a.lesson_consultation_status	as consultationStatus
		from	helf_lesson_consultation a, helf_users b, helf_trainers c
		where a.user_id = #{id}
        and a.user_id = b.user_id
        and a.trainer_no = c.trainer_no
	</select>
	<!-- 수강신청한 강사 조회  -->
	<resultMap type="kr.co.helf.vo.Trainer" id="getTrainersWithCareerByUserId" >
    	<id column="trainer_no" property="trainerNo"/>
    	<result column="trainer_file" property="trainerFile"/>
    	<association property="user" javaType="kr.co.helf.vo.User">
    		<id column="user_id" property="id"/>
    		<result column="name" property="name"/>
    	</association>
    	<collection property="careers" ofType="Career">
        	<id column="career_no" property="careerNo"/>
        	<result column="career_name" property="careerName"/>
        	<result column="career_start_date" property="careerStartDate"/>
        	<result column="career_end_date" property="careerEndDate"/>
    	</collection>
	</resultMap>
	<select id="getTrainersWithCareerByUserId" resultMap="getAllTrainersWithCareer">
		select
			b.trainer_no,
			a.user_name	as name,
			b.trainer_file,
			c.career_no,
			c.career_name,
			c.career_start_date,
			c.career_end_date
		from
		    helf_users a, helf_trainers b, helf_trainer_career c, helf_lesson_consultation d
		where
			a.user_id = b.user_id
        and c.trainer_no = b.trainer_no
        and c.trainer_no = d.trainer_no
        and d.lesson_consultation_status = '대기중'
        and c.trainer_no  in (
    								select trainer_no
									from helf_lesson_consultation
									where user_id = #{value}
									)
		order by
			trainer_no
	</select>
	<select id="getConsultationByTrainerNo" resultType="Consultation">
		select lesson_consultation_no   as consultationNo,
        lesson_consultation_status  as consultationStatus,
        lesson_consultation_application_date as applicationDate,
        lesson_consultation_exercise_goal as goal,
        lesson_consultation_physical_abnormalities as abnormalities,
        lesson_consultation_request_date as requestDate,
        lesson_consultation_request_time as requestTime
		from helf_lesson_consultation
		where trainer_no = #{trainerNo}
		and   user_id = #{id}
		and   lesson_consultation_status = '대기중'
	</select>
</mapper>
